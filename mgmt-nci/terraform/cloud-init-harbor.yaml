#cloud-config
hostname: zy-registry
fqdn: zy-registry.ntnxlab.local

users:
  - default
  - name: nutanix
    gecos: Nutanix User
    groups: [sudo, docker]
    shell: /bin/bash
    lock_passwd: false
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDTUux7jv/rkLVe2T9ADXOMh2JPt/VlNwuR/Jzcmd67S5uf10B8pOjdeMADV+ZJT2sWTwQCzUWgvzyR2cPE+iPVchJ37MMcoOly23pw68Ba953lwV1KMjGML9EFbrj/naqPlDLH2gpFFcEPcQRXwFlWquBEAJ8SA1xp5c5zk1znETeeBh93a+LOos/hn5lQs4Sj2YAZKyw2WV6YbPBcUSw6yVDiLTnfvjVSzeS/N5q5bDDp+ZjB11tvLWqOMrSIA8kTTkjYwKw9OXD//xelckhBanEPWP5ivYEwxVu/24ZTv7or3NUhnj57pT5Z6GIKqetH5Qnn8stUhwvf9vkg8/zLjjTdb5tUF5l/Z+ha8OPSrUl7zHWECG1XInk/rsBB+u3sfhYh7jWvKUsaspuPmsMDU30IDKMJ1/qqUivXBV9eqx1luY1ag2ozFsmCU10dfecQMYBftpcPumgWMOlsddazhstOkWQNi/Ns+U9o8PDQf9B9cgEhen7bCoaivV/qu3M= yi.zhou@LN475QK5FH

chpasswd:
  expire: false
  users:
    - name: nutanix
      password: ntnx/4NKP
      type: text

ssh_pwauth: true

# Create docker group early (before package installations)
groups:
  - docker

# Package installations
packages:
  - apt-transport-https
  - vim
  - htop
  - net-tools
  - bash-completion
  - curl
  - wget
  - git
  - gnupg
  - lsb-release
  - ca-certificates
  - jq
  - unzip
  - tree
  - tmux

# Write SSH keypair for nutanix user
write_files:
  - path: /home/nutanix/.ssh/id_rsa
    owner: nutanix:nutanix
    permissions: "0600"
    defer: true
    content: |
      -----BEGIN OPENSSH PRIVATE KEY-----
      b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
      NhAAAAAwEAAQAAAYEA01Lse47/65C1Xtk/QA1zjIdiT7f1ZTcLkfyc3Jneu0ubn9dAfKTo
      3XjAA1fmSU9rFk8EAs1FoL88kdnDxPoj1XISd+zDHKDpctt6cOvAWved5cFdSjIxjC/RBW
      64/52qj5Qyx9oKRRXBD3EEV8BZVqrgRACfEgNcaeXOc5Nc5xE3ngYfd2vizqLP4Z+ZULOE
      o9mAGSssNllemGzwXFEsOslQ4i053741Us3kvzeauWww6fmYwddbby1qjjK0iAPJE05I2M
      CsPTlw//8XpXJIQWpxD1j+Yr2BMMVbv9uGU7+6K9zVIZ4+e6U+WehiCqnrR+UJ5/LLVIcL
      3/b5IPP8y4403W+bVBeZf2foWvDj0q1Je8x1hAhtVyJ5P67AQfrt7H4WIe41rylLGrKbj5
      rDA1N9CAyjCdf6qlIr1wVfXqsdZbmNWoNqMxbJglNdHX3nEDGAX7aXD7poFjDpbHXWs4bL
      TpFkDYvzbPlPaPDw0H/QfXIBIXp+2wqGor1f6rtzAAAFiPQ1OQX0NTkFAAAAB3NzaC1yc2
      EAAAGBANNS7HuO/+uQtV7ZP0ANc4yHYk+39WU3C5H8nNyZ3rtLm5/XQHyk6N14wANX5klP
      axZPBALNRaC/PJHZw8T6I9VyEnfswxyg6XLbenDrwFr3neXBXUoyMYwv0QVuuP+dqo+UMs
      faCkUVwQ9xBFfAWVaq4EQAnxIDXGnlznOTXOcRN54GH3dr4s6iz+GfmVCzhKPZgBkrLDZZ
      Xphs8FxRLDrJUOItOd++NVLN5L83mrlsMOn5mMHXW28tao4ytIgDyRNOSNjArD05cP//F6
      VySEFqcQ9Y/mK9gTDFW7/bhlO/uivc1SGePnulPlnoYgqp60flCefyy1SHC9/2+SDz/MuO
      NN1vm1QXmX9n6Frw49KtSXvMdYQIbVcieT+uwEH67ex+FiHuNa8pSxqym4+awwNTfQgMow
      nX+qpSK9cFX16rHWW5jVqDajMWyYJTXR195xAxgF+2lw+6aBYw6Wx11rOGy06RZA2L82z5
      T2jw8NB/0H1yASF6ftsKhqK9X+q7cwAAAAMBAAEAAAGAS9ZDdagA4anB3PL7xuHM6M6hEl
      jDIPqbFV3hcS1rCC3/AGLACrsnsmsmBU0jIIX2uT/MAbFm3mQiuXi7z9Gw0GWqiQ0XjAuX
      G5f2HdYM5thb+trkvr66l0OFsHxmuZz8W6BkhOITs202JnN5ioBFz1ttNho++7jnDj3hVA
      q7WVUNb5Fk83dtIpi9H4wl+hcib6abWOzsZei2kN7vd0HOLJ6Yf0KZtVjOTBQFljW/OfHA
      sAbZsh61+nUC+1ro/LLWbBqOd6jG0eLdhuvgf3nLtXfLwXWJnbvaVe1bPBgI+8WBbMb9Fw
      ZbfrKULBHjtpki5rSyqkVqvPosmIPq3PdakVVJH1fQWB2yOAJE7fr8XIPSsO/dbnDTPGSe
      ktvldTn1crqc4VTlr6CRIyA89HFk0RJAp/KCZ9/vIo4/N9g1ddLZnLJZQ1oGd3ESw+NLJ1
      VCJiX5U/uEokoGF0J7Qf3Y0A7N3rNsRzMUFHrmi3xIHJab0nh/FpmaBFAnz4OtozFBAAAA
      wATOhTLJP9aE62iHIYFzXPkJcDYRTzuYmUaCdQ2b4kM8wevdCkBWtRw4ElqWSdqihxKq5m
      auAQCVADoVDLy0ro9Upa7hbAV/lihDwVXzSFUZ9BnmH1m+KiH1vLbSkiP22xrfUK7AwIvh
      P5fwbTSrFdyk5rUn+Q/SIVdzUVER7EYTsSl2FBhYcjCV3QyxeFgU9Z4mmHhbU5LlSb7tSY
      /DXKrXwkh5dUMWfKQNeItUDaqdf+sZlJteHLE/ELxm7ah8vwAAAMEA8imFaL/DUgQcFlq3
      oG8OM8TIN1y5D/s+AxLMcWDy0ic3pg/Z+vWyz+Ze4qBJgU0hyxQejVKnY7mgg3vHxy0Dk9
      oIs16cZuZSOpNld2rHmLnpcDCPDwejluWudXGksDCs5TO2N0Jn+rgylF7W610ku0LC365g
      Kni6V50vALEj0F8s3eQwVrynVnEQ50CL2F8j/BrKgVLuMM0fyTFp6v1XBlCINXDVQAi5uK
      XfRxQ7WxF/iYcjkfML+27hPXgu7DhTAAAAwQDfZkiniQTt2IuGLBfhztND3qkwcXHtIhHf
      aAeZxCKLs9FWJ0LcKzC9EAJ/QnAnbvLJSUpeLxn6C2m+J+5CCPvuav0q8BgrT8u38VAsds
      UTu2oB7+1Pp4wIGcEY6LbZ188k3/J7OVEcjWNUGcBNT427RPz3baM7TTF4ide62eJMzKBC
      kBqLYFZH4PFyWk740ChTGX3jeWPR00ZDIVKL2opYQphrMgzJqpe+PgFrKZImWEqxc4d18T
      h8/VuUDwx0jGEAAAASeWkuemhvdUBMTjQ3NVFLNUZIAQ==
      -----END OPENSSH PRIVATE KEY-----
  - path: /home/nutanix/.ssh/id_rsa.pub
    owner: nutanix:nutanix
    permissions: "0644"
    defer: true
    content: |
      ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDTUux7jv/rkLVe2T9ADXOMh2JPt/VlNwuR/Jzcmd67S5uf10B8pOjdeMADV+ZJT2sWTwQCzUWgvzyR2cPE+iPVchJ37MMcoOly23pw68Ba953lwV1KMjGML9EFbrj/naqPlDLH2gpFFcEPcQRXwFlWquBEAJ8SA1xp5c5zk1znETeeBh93a+LOos/hn5lQs4Sj2YAZKyw2WV6YbPBcUSw6yVDiLTnfvjVSzeS/N5q5bDDp+ZjB11tvLWqOMrSIA8kTTkjYwKw9OXD//xelckhBanEPWP5ivYEwxVu/24ZTv7or3NUhnj57pT5Z6GIKqetH5Qnn8stUhwvf9vkg8/zLjjTdb5tUF5l/Z+ha8OPSrUl7zHWECG1XInk/rsBB+u3sfhYh7jWvKUsaspuPmsMDU30IDKMJ1/qqUivXBV9eqx1luY1ag2ozFsmCU10dfecQMYBftpcPumgWMOlsddazhstOkWQNi/Ns+U9o8PDQf9B9cgEhen7bCoaivV/qu3M= yi.zhou@LN475QK5FH

# Run commands after packages are installed
runcmd:
  - ufw --force disable

  # # Add DNS server if AD & DNS not set
  # - echo "DNS=8.8.8.8 8.8.4.4" >> /etc/systemd/resolved.conf
  # - systemctl restart systemd-resolved

  # Ensure bash-completion is loaded for all users
  - |
    for u in ubuntu nutanix; do
      HOME_DIR="/home/$u"
      if [ -f "$HOME_DIR/.bashrc" ] && ! grep -q "bash-completion" "$HOME_DIR/.bashrc"; then
        cat << 'EOF' >> "$HOME_DIR/.bashrc"

    # Enable bash-completion
    if ! shopt -oq posix; then
      if [ -f /usr/share/bash-completion/bash_completion ]; then
        . /usr/share/bash-completion/bash_completion
      elif [ -f /etc/bash_completion ]; then
        . /etc/bash_completion
      fi
    fi

    EOF
          fi
        done

        # Root has a different home
        if [ -f /root/.bashrc ] && ! grep -q "bash-completion" /root/.bashrc; then
          cat << 'EOF' >> /root/.bashrc

    # Enable bash-completion
    if ! shopt -oq posix; then
      if [ -f /usr/share/bash-completion/bash_completion ]; then
        . /usr/share/bash-completion/bash_completion
      elif [ -f /etc/bash_completion ]; then
        . /etc/bash_completion
      fi
    fi

    EOF
        fi

  # Ensure /usr/local/bin is in PATH for all users
  - echo 'export PATH="/usr/local/bin:$PATH"' >> /home/ubuntu/.bashrc
  - echo 'export PATH="/usr/local/bin:$PATH"' >> /home/nutanix/.bashrc
  - echo 'export PATH="/usr/local/bin:$PATH"' >> /root/.bashrc

  # Install kubectl
  - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
  - install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
  - rm -f kubectl

  # Configure kubectl bash completion for all users
  - echo "source <(kubectl completion bash)" >> /home/ubuntu/.bashrc
  - echo "alias k=kubectl" >> /home/ubuntu/.bashrc
  - echo "complete -o default -F __start_kubectl k" >> /home/ubuntu/.bashrc
  - echo "source <(kubectl completion bash)" >> /home/nutanix/.bashrc
  - echo "alias k=kubectl" >> /home/nutanix/.bashrc
  - echo "complete -o default -F __start_kubectl k" >> /home/nutanix/.bashrc
  - echo "source <(kubectl completion bash)" >> /root/.bashrc
  - echo "alias k=kubectl" >> /root/.bashrc
  - echo "complete -o default -F __start_kubectl k" >> /root/.bashrc

  # Fix permissions on home directories
  - chown -R ubuntu:ubuntu /home/ubuntu
  - chown -R nutanix:nutanix /home/nutanix

  # Ensure .ssh directory has correct permissions
  - mkdir -p /home/nutanix/.ssh
  - chmod 700 /home/nutanix/.ssh
  - chown -R nutanix:nutanix /home/nutanix/.ssh

final_message: "Harbor VM is ready."

